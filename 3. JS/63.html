<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>18.4 Performance &amp; Optimization APIs — Performance, Workers, rAF</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
  <style>
    :root{--bg:#0d1117;--surface:#0f1724;--muted:#9ca3af;--cyan:#06b6d4;--amber:#f59e0b;--panel-width:360px;--radius:12px;--mono:ui-monospace,SFMono-Regular,Menlo,Monaco,'Roboto Mono','Courier New',monospace}
    html,body{height:100%;background:var(--bg);color:#e6eef6;font-family:Inter, system-ui, -apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;margin:0}
    .app{display:flex;height:100vh;gap:20px;padding:20px;box-sizing:border-box}
    .left{width:var(--panel-width);min-width:260px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:var(--radius);padding:18px;box-shadow:0 6px 18px rgba(2,6,23,0.7);position:sticky;top:20px;height:calc(100vh - 40px);overflow:auto}
    .right{flex:1;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:var(--radius);padding:28px;box-shadow:0 6px 18px rgba(2,6,23,0.7);height:calc(100vh - 40px);overflow:auto}
    h1,h2,h3{color:#fff}
    .muted{color:var(--muted)}
    .toc-search{display:flex;gap:8px;margin-bottom:12px}
    .toc-list{list-style:none;padding:0;margin:0}
    .toc-item{padding:8px 10px;border-radius:8px;cursor:pointer}
    .toc-item:hover{background:rgba(255,255,255,0.02)}
    pre{background:rgba(255,255,255,0.02);padding:14px;border-radius:10px;overflow:auto;font-family:var(--mono);font-size:13px}
    code{font-family:var(--mono);font-size:13px}
    details{background:rgba(255,255,255,0.01);margin:10px 0;padding:10px;border-radius:8px}
    details[open]{box-shadow:0 8px 24px rgba(2,6,23,0.7)}
    summary{cursor:pointer;outline:none;padding:6px 8px;border-radius:6px}
    summary::-webkit-details-marker{display:none}
    .summary-title{display:flex;align-items:center;gap:10px}
    .pill{padding:2px 8px;border-radius:999px;background:rgba(245,158,11,0.12);color:var(--amber);font-size:12px}
    .section{padding-top:8px;margin-top:8px;border-top:1px dashed rgba(255,255,255,0.03)}
    .highlight{background:linear-gradient(90deg, rgba(6,182,212,0.06), transparent);}
    .controls{display:flex;gap:8px;margin-bottom:12px}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .perf-table{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    @media (max-width:900px){.app{flex-direction:column;padding:12px}.left{width:100%;position:relative;height:auto}.right{height:auto}}
  </style>
</head>
<body>
  <div class="app container-fluid">
    <aside class="left">
      <div class="d-flex align-items-start mb-3">
        <div>
          <h4 class="mb-0">18.4 Performance &amp; Optimization APIs</h4>
          <div class="muted">Performance API, Web Workers, Service Workers, Page Visibility, rAF — JavaScript</div>
          <div class="mt-2"><small class="muted">Author: Advanced JS Tutor • Updated: Nov 28, 2025</small></div>
        </div>
      </div>

      <div class="toc-search">
        <input id="tocSearch" class="form-control form-control-sm" placeholder="Search TOC..." aria-label="Search table of contents"/>
        <button id="tocClear" class="btn btn-sm btn-outline-secondary">Clear</button>
      </div>

      <div class="controls">
        <button id="expandAll" class="btn btn-sm btn-primary">Expand all</button>
        <button id="collapseAll" class="btn btn-sm btn-ghost">Collapse all</button>
        <button id="tocCollapse" class="btn btn-sm btn-ghost">Collapse TOC</button>
      </div>

      <nav>
        <ul id="tocList" class="toc-list">
          <li class="toc-item" data-target="intro">Introduction &amp; Exec Summary</li>
          <li class="toc-item" data-target="perfapi">Performance API &amp; metrics</li>
          <li class="toc-item" data-target="workers">Web Workers for background tasks</li>
          <li class="toc-item" data-target="service">Service Workers for offline</li>
          <li class="toc-item" data-target="visibility">Page Visibility API</li>
          <li class="toc-item" data-target="raf">requestAnimationFrame &amp; animations</li>
          <li class="toc-item" data-target="patterns">Patterns &amp; Checklist</li>
          <li class="toc-item" data-target="examples">Examples &amp; Tools</li>
        </ul>
      </nav>
    </aside>

    <main class="right" id="content">
      <section id="intro" class="section">
        <h2>Introduction &amp; Executive Summary <span class="pill">Quick</span></h2>
        <details open>
          <summary><div class="summary-title"><strong>Executive summary</strong><span class="muted">(short)</span></div></summary>
          <div class="mt-2 muted">This module focuses on browser APIs that help measure and improve performance: the Performance API for precise timing and metrics; Web Workers to offload CPU-heavy tasks; Service Workers to enable offline and caching; Page Visibility API to adapt behavior when tabs are hidden; and requestAnimationFrame for smooth animations. We'll provide patterns, code, and profiling tips.</div>
        </details>

        <details>
          <summary><div class="summary-title"><strong>Why this matters</strong></div></summary>
          <div class="mt-2">User-perceived performance is critical. Tools/APIs in this module let you measure what matters, move heavy work off the main thread, reduce wasted network or compute, and create smooth animation loops aligned with the browser's rendering pipeline.</div>
        </details>
      </section>

      <section id="perfapi" class="section">
        <h3>Performance API &amp; Metrics</h3>
        <details>
          <summary><div class="summary-title"><strong>Core concepts</strong></div></summary>
          <div class="mt-2">The Performance API (<code>performance.now()</code>, <code>performance.mark()</code>, <code>performance.measure()</code>) provides high-resolution timestamps and a timeline for diagnostics. Use it to measure durations with millisecond precision (<code>performance.now()</code> is monotonic and more precise than Date.now()).</div>
        </details>

        <details>
          <summary><div class="summary-title"><strong>Basic usage</strong></div></summary>
          <div class="mt-2">
            <pre><code>// measuring a function
performance.mark('startHeavy');
heavyWork();
performance.mark('endHeavy');
performance.measure('heavyWork', 'startHeavy', 'endHeavy');
const entries = performance.getEntriesByName('heavyWork');
console.log(entries[0].duration);
</code></pre>
          </div>
        </details>

        <details>
          <summary><div class="summary-title"><strong>Long tasks &amp; FPS</strong></div></summary>
          <div class="mt-2">Detect long tasks (tasks &gt; 50ms) via the Long Tasks API (performanceObserver for 'longtask') and monitor frame rates to find jank sources.</div>
          <pre><code>// observe long tasks
if('PerformanceObserver' in window){
  const obs = new PerformanceObserver(list =&gt; {
    for(const entry of list.getEntries()){
      console.warn('long task', entry);
    }
  });
  try{ obs.observe({ type: 'longtask', buffered: true }); }catch(e){}
}
</code></pre>
        </details>
      </section>

      <section id="workers" class="section">
        <h3>Web Workers</h3>
        <details>
          <summary><div class="summary-title"><strong>Overview</strong></div></summary>
          <div class="mt-2">Web Workers run JavaScript on a separate thread, useful for CPU-heavy tasks (parsing, compression, image processing). Workers can't access DOM directly; communicate via message passing (<code>postMessage</code>). Use SharedArrayBuffer/WebAssembly for advanced use-cases when available.</div>
        </details>

        <details>
          <summary><div class="summary-title"><strong>Basic worker example</strong></div></summary>
          <div class="mt-2">
            <pre><code>// worker.js
self.addEventListener('message', (ev) =&gt; {
  const result = heavyComputation(ev.data);
  self.postMessage(result);
});

// main thread
const w = new Worker('worker.js');
w.postMessage({ n: 1000000 });
w.onmessage = (ev) =&gt; { console.log('result', ev.data); };
</code></pre>
          </div>
        </details>

        <details>
          <summary><div class="summary-title"><strong>Transferable objects</strong></div></summary>
          <div class="mt-2">Use <code>postMessage</code> with Transferable objects (ArrayBuffer, MessagePort) to avoid copying large buffers; pass <code>[buffer]</code> as second arg to transfer ownership.</div>
          <pre><code>const buffer = new ArrayBuffer(1024*1024);
worker.postMessage(buffer, [buffer]); // buffer is neutered on main thread
</code></pre>
        </details>

        <details>
          <summary><div class="summary-title"><strong>Worker lifecycle &amp; pooling</strong></div></summary>
          <div class="mt-2">Create pools for repeated tasks; avoid spinning up new workers per task. Terminate workers with <code>worker.terminate()</code> when done. Use dedicated pools or libraries for management.</div>
        </details>
      </section>

      <section id="service" class="section">
        <h3>Service Workers</h3>
        <details>
          <summary><div class="summary-title"><strong>Overview</strong></div></summary>
          <div class="mt-2">Service Workers act as a programmable network proxy in the background; they enable offline caching, background sync, and push notifications. They run separately from pages and have a lifecycle (install, activate, fetch).</div>
        </details>

        <details>
          <summary><div class="summary-title"><strong>Simple caching strategy</strong></div></summary>
          <div class="mt-2">
            <pre><code>// service-worker.js (install + cache)
self.addEventListener('install', (ev) =&gt; {
  ev.waitUntil(
    caches.open('app-v1').then(cache =&gt; cache.addAll(['/','/index.html','/app.js']))
  );
});

self.addEventListener('fetch', (ev) =&gt; {
  ev.respondWith(caches.match(ev.request).then(r =&gt; r || fetch(ev.request)));
});
</code></pre>
          </div>
        </details>

        <details>
          <summary><div class="summary-title"><strong>Update &amp; skipWaiting</strong></div></summary>
          <div class="mt-2">Call <code>self.skipWaiting()</code> during install and <code>clients.claim()</code> in activate for immediate control, but coordinate with the app to avoid breaking in-flight pages.</div>
        </details>
      </section>

      <section id="visibility" class="section">
        <h3>Page Visibility API</h3>
        <details>
          <summary><div class="summary-title"><strong>Overview</strong></div></summary>
          <div class="mt-2">Use the Page Visibility API to pause or reduce work when the page is hidden (e.g., background tab). This saves CPU and battery. Listen for <code>visibilitychange</code> and check <code>document.visibilityState</code>.</div>
        </details>

        <details>
          <summary><div class="summary-title"><strong>Example</strong></div></summary>
          <div class="mt-2">
            <pre><code>document.addEventListener('visibilitychange', () =&gt; {
  if(document.visibilityState === 'hidden'){
    // pause animations, reduce polling
  } else {
    // resume
  }
});
</code></pre>
          </div>
        </details>
      </section>

      <section id="raf" class="section">
        <h3>requestAnimationFrame (rAF) for Smooth Animations</h3>
        <details>
          <summary><div class="summary-title"><strong>Overview</strong></div></summary>
          <div class="mt-2">Use <code>requestAnimationFrame</code> to schedule DOM reads/writes aligned with the browser's paint cycle. Avoid setTimeout for animations — rAF provides frame-aligned timestamps and pauses in background tabs.</div>
        </details>

        <details>
          <summary><div class="summary-title"><strong>Basic loop</strong></div></summary>
          <div class="mt-2">
            <pre><code>let last = performance.now();
function loop(now){
  const dt = now - last;
  last = now;
  updateAnimation(dt);
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</code></pre>
          </div>
        </details>

        <details>
          <summary><div class="summary-title"><strong>Throttling DOM writes with rAF</strong></div></summary>
          <div class="mt-2">Collect events (scroll/mousemove) and schedule DOM writes in rAF to avoid layout thrash.</div>
          <pre><code>let scheduled = false;
let lastEvent;
function onScroll(e){ lastEvent = e; if(!scheduled){ scheduled = true; requestAnimationFrame(() =&gt; { applyScroll(lastEvent); scheduled = false; }); } }
window.addEventListener('scroll', onScroll, { passive: true });
</code></pre>
        </details>
      </section>

      <section id="patterns" class="section">
        <h3>Patterns &amp; Checklist</h3>
        <details>
          <summary><div class="summary-title"><strong>Checklist</strong></div></summary>
          <div class="mt-2">
            <ul>
              <li>Measure first: use Performance API &amp; DevTools before optimizing.</li>
              <li>Move heavy CPU work to Web Workers; use Transferable for large buffers.</li>
              <li>Use Service Workers to cache assets and implement offline strategies.</li>
              <li>Use rAF for visual updates; batch reads/writes to avoid reflows.</li>
              <li>Pause work on hidden pages (Visibility API) and detect long tasks.</li>
              <li>Profile using Chrome DevTools Performance and Lighthouse.</li>
            </ul>
          </div>
        </details>
      </section>

      <section id="examples" class="section">
        <h3>Examples &amp; Tools</h3>
        <details>
          <summary><div class="summary-title"><strong>Example: offload image processing to worker</strong></div></summary>
          <div class="mt-2">
            <pre><code>// worker: blur-worker.js
self.addEventListener('message', ({data}) =&gt; {
  const { imageData } = data; // ArrayBuffer or transferable
  const result = heavyBlur(imageData);
  postMessage({ result }, [result.buffer]);
});

// main thread
const worker = new Worker('blur-worker.js');
worker.postMessage({ imageData: buffer }, [buffer]);
worker.onmessage = (ev) =&gt; render(ev.data.result);
</code></pre>
          </div>
        </details>

        <details>
          <summary><div class="summary-title"><strong>Example: measure component render time</strong></div></summary>
          <div class="mt-2">
            <pre><code>function renderComponent(){
  performance.mark('comp-start');
  // DOM work
  performance.mark('comp-end');
  performance.measure('comp-render', 'comp-start', 'comp-end');
  console.log(performance.getEntriesByName('comp-render')[0].duration);
}
</code></pre>
          </div>
        </details>

        <details>
          <summary><div class="summary-title"><strong>Tools</strong></div></summary>
          <div class="mt-2">
            <ul>
              <li>Chrome DevTools &gt; Performance / Coverage / Lighthouse</li>
              <li>WebPageTest for real-world metrics</li>
              <li>PerformanceObserver API and Long Task API</li>
            </ul>
          </div>
        </details>
      </section>

      <footer class="mt-4 muted"><small>Designed for students from college to PhD. Want runnable worker demos, build scripts, or integration with frameworks (React concurrent mode), I can add them. — Advanced JS Tutor</small></footer>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <script>
    document.querySelectorAll('.toc-item').forEach(item =&gt; {
      item.addEventListener('click', () =&gt; {
        const target = document.getElementById(item.dataset.target);
        if(target){
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          document.querySelectorAll('.section').forEach(s =&gt; s.classList.remove('highlight'));
          target.classList.add('highlight');
          setTimeout(() =&gt; target.classList.remove('highlight'), 1400);
        }
      });
    });

    const tocSearch = document.getElementById('tocSearch');
    const tocList = document.getElementById('tocList');
    tocSearch.addEventListener('input', (e) =&gt; {
      const q = e.target.value.trim().toLowerCase();
      Array.from(tocList.children).forEach(li =&gt; {
        const text = li.textContent.trim().toLowerCase();
        li.style.display = text.includes(q) ? '' : 'none';
      });
    });
    document.getElementById('tocClear').addEventListener('click', () =&gt; { tocSearch.value=''; tocSearch.dispatchEvent(new Event('input')); });

    function setAll(open){ document.querySelectorAll('main details').forEach(d =&gt; { d.open = open; }); }
    document.getElementById('expandAll').addEventListener('click', () =&gt; setAll(true));
    document.getElementById('collapseAll').addEventListener('click', () =&gt; setAll(false));

    document.getElementById('tocCollapse').addEventListener('click', () =&gt; {
      const left = document.querySelector('.left');
      if(left.style.width === '64px'){ left.style.width = getComputedStyle(document.documentElement).getPropertyValue('--panel-width'); }
      else { left.style.width = '64px'; }
    });

    document.addEventListener('DOMContentLoaded', (ev) =&gt; {
      if(window.hljs) hljs.highlightAll();
    });
  </script>
</body>
</html>
